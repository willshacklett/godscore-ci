name: GodScore Dashboard (GitHub Pages)

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "dashboard/data/history.json"   # prevents infinite loop when we commit history
  workflow_dispatch: {}

permissions:
  contents: write     # needed to commit history.json
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Ensure history file exists
      - name: Ensure history.json
        run: |
          mkdir -p dashboard/data
          if [ ! -f dashboard/data/history.json ]; then
            echo "[]" > dashboard/data/history.json
          fi

      # 2) Generate a snapshot (placeholder for now)
      - name: Generate snapshot
        run: |
          python - << 'PY'
          import json, os, datetime
          score = 80  # TODO: wire to real godscore-ci output next step

          snap = {
            "ts": datetime.datetime.utcnow().isoformat() + "Z",
            "ref": os.environ.get("GITHUB_REF_NAME", "main"),
            "sha": os.environ.get("GITHUB_SHA", "")[:7],
            "godscore": score
          }

          with open("dashboard/data/snapshot.json","w") as f:
            json.dump(snap, f, indent=2)
          print("snapshot:", snap)
          PY

      # 3) Append snapshot to history.json (keep last 200)
      - name: Append history
        run: |
          python - << 'PY'
          import json
          from pathlib import Path

          hist_path = Path("dashboard/data/history.json")
          snap_path = Path("dashboard/data/snapshot.json")

          hist = json.loads(hist_path.read_text())
          snap = json.loads(snap_path.read_text())

          if not any(x.get("sha") == snap.get("sha") for x in hist):
            hist.append(snap)

          hist = hist[-200:]
          hist_path.write_text(json.dumps(hist, indent=2))
          print("history entries:", len(hist))
          PY

      # 4) Commit history back to main (but only if actor isn't the bot)
      - name: Commit history.json
        if: github.actor != 'github-actions[bot]'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dashboard/data/history.json dashboard/data/snapshot.json || true
          git commit -m "Update GodScore dashboard data" || echo "No changes"
          git push || true

      # 5) Upload the site for Pages (serve from repo root)
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      # 6) Deploy
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
