name: GodScore Attestation (GitHub Pages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write   # âœ… REQUIRED for keyless Sigstore signing (OIDC)

jobs:
  publish_attestation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate v1 output (env + signals)
        run: |
          mkdir -p api/out
          export GODSCORE_SIGNALS_PATH=api/example_signals.v1.json
          python api/generate_v1.py api/example_output.v1.json api/out/godscore.output.v1.json

      - name: Validate v1 output against contract
        run: |
          python api/validate_v1.py api/schema.v1.json api/out/godscore.output.v1.json

      - name: Build attestation (HMAC signed)
        env:
          GODSCORE_ATTESTATION_HMAC: ${{ secrets.GODSCORE_ATTESTATION_HMAC }}
        run: |
          mkdir -p attestation
          python api/build_attestation.py api/out/godscore.output.v1.json attestation/godscore.json

      # âœ… Install Cosign for keyless signing
      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      # âœ… Keyless (public-verifiable) signature bundle
      - name: Sigstore sign attestation (keyless)
        run: |
          cosign version
          cosign sign-blob --yes \
            --bundle attestation/godscore.sigstore.json \
            attestation/godscore.json

      # ðŸ”¹ Publish into docs/ for GitHub Pages
      - name: Publish attestation to docs/.well-known
        run: |
          mkdir -p docs/.well-known

          # Main attestation + HMAC signature
          cp attestation/godscore.json docs/.well-known/godscore.json
          cp attestation/godscore.json.sig docs/.well-known/godscore.sig

          # Public-verifiable sigstore bundle
          cp attestation/godscore.sigstore.json docs/.well-known/godscore.sigstore.json

          # Convenience copies at site root
          cp attestation/godscore.json docs/godscore.json
          cp attestation/godscore.json.sig docs/godscore.sig
          cp attestation/godscore.sigstore.json docs/godscore.sigstore.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            docs/.well-known/godscore.json \
            docs/.well-known/godscore.sig \
            docs/.well-known/godscore.sigstore.json \
            docs/godscore.json \
            docs/godscore.sig \
            docs/godscore.sigstore.json
          git commit -m "chore: publish signed godscore attestation (hmac + sigstore)" || echo "No changes to commit"
          git push
