name: GodScore Attestation (GitHub Pages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write   # required for keyless sigstore signing

jobs:
  publish_attestation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate v1 output (env + signals)
        run: |
          mkdir -p api/out
          export GODSCORE_SIGNALS_PATH=api/example_signals.v1.json
          python api/generate_v1.py api/example_output.v1.json api/out/godscore.output.v1.json

      - name: Validate v1 output against contract
        run: |
          python api/validate_v1.py api/schema.v1.json api/out/godscore.output.v1.json

      - name: Build attestation (HMAC signed)
        env:
          GODSCORE_ATTESTATION_HMAC: ${{ secrets.GODSCORE_ATTESTATION_HMAC }}
        run: |
          mkdir -p attestation
          python api/build_attestation.py api/out/godscore.output.v1.json attestation/godscore.json

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sigstore sign attestation (keyless)
        run: |
          cosign sign-blob --yes \
            --bundle attestation/godscore.sigstore.json \
            attestation/godscore.json

      # ✅ Save the files to runner temp so branch switching doesn't lose them
      - name: Stage attestation files for publishing
        run: |
          mkdir -p "$RUNNER_TEMP/godscore_att"
          cp attestation/godscore.json "$RUNNER_TEMP/godscore_att/godscore.json"
          cp attestation/godscore.json.sig "$RUNNER_TEMP/godscore_att/godscore.sig"
          cp attestation/godscore.sigstore.json "$RUNNER_TEMP/godscore_att/godscore.sigstore.json"

      # ✅ Checkout gh-pages WITHOUT overwriting the dashboard
      - name: Checkout gh-pages (create if missing)
        run: |
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

      # ✅ Copy files into the Pages root so URLs work exactly as designed
      - name: Publish to .well-known on GitHub Pages
        run: |
          mkdir -p .well-known
          cp "$RUNNER_TEMP/godscore_att/godscore.json" .well-known/godscore.json
          cp "$RUNNER_TEMP/godscore_att/godscore.sig" .well-known/godscore.sig
          cp "$RUNNER_TEMP/godscore_att/godscore.sigstore.json" .well-known/godscore.sigstore.json

          # Optional convenience copies (non-standard but handy)
          cp "$RUNNER_TEMP/godscore_att/godscore.json" godscore.json
          cp "$RUNNER_TEMP/godscore_att/godscore.sig" godscore.sig
          cp "$RUNNER_TEMP/godscore_att/godscore.sigstore.json" godscore.sigstore.json

      - name: Commit and push gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .well-known/godscore.json .well-known/godscore.sig .well-known/godscore.sigstore.json godscore.json godscore.sig godscore.sigstore.json
          git commit -m "chore: publish godscore attestation (.well-known + sigstore)" || echo "No changes to commit"
          git push origin gh-pages
